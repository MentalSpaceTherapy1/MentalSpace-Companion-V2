rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // Helper Functions
    // =========================================================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if the requesting user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if the request is creating a new document
    function isCreate() {
      return request.method == 'create';
    }

    // Check if the request is updating an existing document
    function isUpdate() {
      return request.method == 'update';
    }

    // Check if the request is deleting a document
    function isDelete() {
      return request.method == 'delete';
    }

    // Validate metric value is between 1 and 10
    function isValidMetric(value) {
      return value is int && value >= 1 && value <= 10;
    }

    // Validate date string format (YYYY-MM-DD)
    function isValidDateString(value) {
      return value is string && value.matches('^[0-9]{4}-[0-9]{2}-[0-9]{2}$');
    }

    // Check if user has admin role (for future admin features)
    function isAdmin() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/admin_users/$(request.auth.uid));
    }

    // =========================================================================
    // User Documents
    // =========================================================================

    match /users/{userId} {
      // Users can only read and write their own profile
      allow read: if isOwner(userId);

      // Allow create if authenticated and creating own profile
      allow create: if isOwner(userId) &&
        request.resource.data.keys().hasAll(['email', 'displayName', 'createdAt']) &&
        request.resource.data.email is string &&
        request.resource.data.displayName is string;

      // Allow update if authenticated and updating own profile
      allow update: if isOwner(userId) &&
        // Prevent changing critical fields
        request.resource.data.email == resource.data.email &&
        request.resource.data.createdAt == resource.data.createdAt;

      // Never allow delete (soft delete only via Cloud Functions)
      allow delete: if false;

      // -----------------------------------------------------------------------
      // User Subcollections
      // -----------------------------------------------------------------------

      // Check-ins
      match /checkins/{checkinId} {
        allow read: if isOwner(userId);

        allow create: if isOwner(userId) &&
          request.resource.data.keys().hasAll(['date', 'mood', 'stress', 'sleep', 'energy', 'focus', 'anxiety', 'createdAt']) &&
          isValidDateString(request.resource.data.date) &&
          isValidMetric(request.resource.data.mood) &&
          isValidMetric(request.resource.data.stress) &&
          isValidMetric(request.resource.data.sleep) &&
          isValidMetric(request.resource.data.energy) &&
          isValidMetric(request.resource.data.focus) &&
          isValidMetric(request.resource.data.anxiety);

        // Allow limited updates (e.g., journal entry edits)
        allow update: if isOwner(userId) &&
          // Cannot change core metrics after creation
          request.resource.data.mood == resource.data.mood &&
          request.resource.data.stress == resource.data.stress &&
          request.resource.data.sleep == resource.data.sleep &&
          request.resource.data.energy == resource.data.energy &&
          request.resource.data.focus == resource.data.focus &&
          request.resource.data.anxiety == resource.data.anxiety &&
          request.resource.data.date == resource.data.date &&
          request.resource.data.createdAt == resource.data.createdAt;

        // Never allow delete (for data integrity)
        allow delete: if false;
      }

      // Daily Plans
      match /plans/{planId} {
        allow read: if isOwner(userId);

        allow create: if isOwner(userId) &&
          request.resource.data.keys().hasAll(['date', 'createdAt', 'checkinId', 'actions']) &&
          isValidDateString(request.resource.data.date);

        // Allow updates for action completion
        allow update: if isOwner(userId) &&
          request.resource.data.date == resource.data.date &&
          request.resource.data.createdAt == resource.data.createdAt &&
          request.resource.data.checkinId == resource.data.checkinId;

        allow delete: if false;
      }

      // Crisis Events (audit log - no updates or deletes)
      match /crisis_events/{eventId} {
        allow read: if isOwner(userId);

        allow create: if isOwner(userId) &&
          request.resource.data.keys().hasAll(['createdAt', 'triggerType', 'severity']);

        // No updates or deletes - this is an audit trail
        allow update: if false;
        allow delete: if false;
      }

      // Weekly Summaries (generated by Cloud Functions)
      match /weekly_summaries/{summaryId} {
        allow read: if isOwner(userId);

        // Only Cloud Functions can write
        allow create: if false;
        allow update: if false;
        allow delete: if false;
      }
    }

    // =========================================================================
    // Global Collections (Read-Only for Users)
    // =========================================================================

    // Actions Library
    match /actions_library/{actionId} {
      // All authenticated users can read
      allow read: if isAuthenticated();

      // Only admins can write (via Cloud Functions)
      allow write: if isAdmin();
    }

    // Focus Modules
    match /focus_modules/{moduleId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // =========================================================================
    // Admin Collections
    // =========================================================================

    match /admin_users/{adminId} {
      // Only the admin themselves can read their admin status
      allow read: if isOwner(adminId);

      // No client-side writes
      allow write: if false;
    }

    // Analytics (aggregated, no PII)
    match /analytics/{docId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    // =========================================================================
    // Contact Submissions (Therapist Matching)
    // =========================================================================

    match /contact_submissions/{submissionId} {
      // Users can create submissions
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.keys().hasAll(['firstName', 'lastName', 'email', 'phone', 'createdAt']);

      // Users can read their own submissions
      allow read: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // No updates or deletes from client
      allow update: if false;
      allow delete: if false;
    }
  }
}
